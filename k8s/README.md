# Track-It Kubernetes Deployment

This directory contains Kubernetes manifests for deploying Track-It to a production cluster.

## Prerequisites

- Kubernetes cluster with:
  - NGINX Ingress Controller installed
  - cert-manager installed with Let's Encrypt issuer configured
  - DigitalOcean block storage (or modify storage class)
- Docker images pushed to registry (ghcr.io/piwi3910/trackit-*)
- kubectl configured to access your cluster

## Deployment Steps

1. **Generate production secrets:**
   ```bash
   ./generate-secrets.sh
   ```
   Save the generated secrets securely!

2. **Create namespace:**
   ```bash
   kubectl apply -f 00-namespace.yaml
   ```

3. **Apply configurations and secrets:**
   ```bash
   kubectl apply -f 01-configmap.yaml
   kubectl apply -f trackit-secrets-generated.yaml  # Generated from step 1
   ```

4. **Deploy databases:**
   ```bash
   kubectl apply -f 03-postgres.yaml
   kubectl apply -f 04-redis.yaml
   ```
   Wait for databases to be ready:
   ```bash
   kubectl -n trackit wait --for=condition=ready pod -l component=postgres --timeout=300s
   kubectl -n trackit wait --for=condition=ready pod -l component=redis --timeout=300s
   ```

5. **Run database migrations:**
   ```bash
   kubectl apply -f 08-migrate-job.yaml
   kubectl -n trackit wait --for=condition=complete job/trackit-migrate --timeout=300s
   ```

6. **Deploy application:**
   ```bash
   kubectl apply -f 05-backend.yaml
   kubectl apply -f 06-frontend.yaml
   ```

7. **Configure ingress:**
   ```bash
   kubectl apply -f 07-ingress.yaml
   ```

8. **Verify deployment:**
   ```bash
   kubectl -n trackit get pods
   kubectl -n trackit get ingress
   ```

## Configuration

### Environment Variables

Edit `01-configmap.yaml` to modify non-sensitive configuration.

### Secrets

Never commit actual secrets! Use the `generate-secrets.sh` script or manually create secrets:

```bash
kubectl create secret generic trackit-secrets \
  --from-literal=JWT_SECRET='your-secret' \
  --from-literal=POSTGRES_PASSWORD='your-password' \
  # ... other secrets
  -n trackit
```

### Google OAuth (Optional)

To enable Google OAuth:
1. Create OAuth credentials in Google Cloud Console
2. Update the secret with your credentials:
   ```bash
   kubectl -n trackit edit secret trackit-secrets
   ```
3. Set `GOOGLE_OAUTH_ENABLED: "true"` in ConfigMap

### Email Service (Optional)

To enable email notifications:
1. Configure SMTP credentials in the secret
2. Update SMTP settings in ConfigMap

## Monitoring

Check application health:
```bash
# Pod status
kubectl -n trackit get pods -w

# Logs
kubectl -n trackit logs -l component=backend -f
kubectl -n trackit logs -l component=frontend -f

# Database logs
kubectl -n trackit logs -l component=postgres
kubectl -n trackit logs -l component=redis
```

## Scaling

Scale deployments:
```bash
# Scale backend
kubectl -n trackit scale deployment backend --replicas=3

# Scale frontend
kubectl -n trackit scale deployment frontend --replicas=3
```

## Backup

### Database Backup

Create a database backup:
```bash
kubectl -n trackit exec -it postgres-0 -- pg_dump -U trackit trackit > backup.sql
```

### Persistent Volume Backup

Backup PVCs using your cloud provider's snapshot functionality.

## Troubleshooting

### SSL Certificate Issues

Check cert-manager logs:
```bash
kubectl logs -n cert-manager deploy/cert-manager
kubectl describe certificate -n trackit trackit-tls
```

### Database Connection Issues

Check database connectivity:
```bash
kubectl -n trackit exec -it deploy/backend -- nc -zv postgres-service 5432
kubectl -n trackit exec -it deploy/backend -- nc -zv redis-service 6379
```

### Ingress Issues

Check ingress controller logs:
```bash
kubectl logs -n ingress-nginx deploy/ingress-nginx-controller
```

## Cleanup

To remove all resources:
```bash
kubectl delete namespace trackit
```

## Security Notes

1. **Always use strong, unique passwords** generated by the script
2. **Never commit secrets** to version control
3. **Rotate secrets regularly** (especially JWT secrets)
4. **Use RBAC** to limit access to the namespace
5. **Enable network policies** for additional security
6. **Regular backups** of database and persistent volumes